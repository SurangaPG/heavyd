<?xml version="1.0"?>

<project name="Project tasks" default="project:help" description="Contains all the task to build a project up from scratch.">

    <!-- @TODO autodetect these -->
    <import file=".phing/build.composer.xml" />
    <import file=".phing/build.property.xml" />
    <import file=".phing/build.drupal.xml" />
    <import file=".phing/build.theme.xml" />
    <import file=".phing/build.drush.xml" />
    <import file=".phing/build.server.xml" />

    <target name="project:install" description="Installs a full website from scratch.">
        <!-- Default values -->
        <property name="final.env" value="local" />
        <property name="final.stage" value="dev" />

        <!-- Enable the install time data -->
        <property name="env.to.activate" value="${final.env}" override="true" />
        <property name="stage.to.activate" value="install" override="true" />

        <phingcall target="project:activate-env" />
        <phingcall target="project:activate-stage" />

        <!-- Generate a .etc/.host file for the local environment -->
        <!-- @TODO implement this -->

        <!-- @TODO Look into the mails being sent during install? -->
        <phingcall target="drush:site-install" />

        <!-- Install the final stage (was forced to install to prevent issues) -->
        <property name="stage.to.activate" value="${final.stage}" override="true" />
        <phingcall target="project:activate-stage" />
    </target>


    <target name="project:build" description="Builds an entire environment up from scratch.">
        <phingcall target="composer:build" />
    </target>

    <target name="project:setup" description="Setups up an already prepared environment">
        <phingcall target="theme:get-assets" />
    </target>

    <target name="project:init" description="Init a new project with all the needed code etc in place.">
        <phingcall target="drupal:init:config" />
        <phingcall target="drupal:init:baseline-module" />
        <phingcall target="drupal:init:baseline-theme" />
        <phingcall target="drupal:init:site-dir" />
        <phingcall target="drupal:init:cleanup" />
    </target>

    <target name="project:property-cleanse" description="Cleanses a project of all properties etc.">
        <phingcall target="property:cleanse" />
        <phingcall target="property:write-full" />
    </target>

    <target name="project:activate-env" description="Activates a full environment">
        <phingcall target="property:cleanse:env" />
        <phingcall target="property:activate:env" />
        <phingcall target="property:write-full" />
        <phingcall target="drupal:env:settings-file" />
    </target>

    <target name="project:activate-stage" description="Activates a the correct stage (e.g production, acc, etc) for a given site (dir).">
        <phingcall target="property:cleanse:stage" />
        <phingcall target="property:activate:stage" />
        <phingcall target="property:write-full" />
        <phingcall target="drupal:stage:activate-etc-files" />
    </target>

    <target name="project:help">
        <exec passthru="true" command="${bin.phing} -l" />
    </target>

</project>
